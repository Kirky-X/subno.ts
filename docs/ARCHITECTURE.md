<div align="center">

# æ¶æ„è®¾è®¡æ–‡æ¡£

### SecureNotify ç³»ç»Ÿæ¶æ„è¯¦è§£

[ğŸ  é¦–é¡µ](../README.md) â€¢ [ğŸ“– ç”¨æˆ·æŒ‡å—](USER_GUIDE.md) â€¢ [ğŸ“˜ API å‚è€ƒ](API_REFERENCE.md)

---

</div>

## ç›®å½•

- [ç³»ç»Ÿæ¦‚è§ˆ](#ç³»ç»Ÿæ¦‚è§ˆ)
- [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
- [æ ¸å¿ƒç»„ä»¶](#æ ¸å¿ƒç»„ä»¶)
- [æ•°æ®æµç¨‹](#æ•°æ®æµç¨‹)
- [å®‰å…¨æ€§è®¾è®¡](#å®‰å…¨æ€§è®¾è®¡)
- [æŠ€æœ¯å†³ç­–](#æŠ€æœ¯å†³ç­–)
- [æ€§èƒ½è€ƒè™‘](#æ€§èƒ½è€ƒè™‘)
- [å¯æ‰©å±•æ€§](#å¯æ‰©å±•æ€§)
- [ç›‘æ§ä¸è¿ç»´](#ç›‘æ§ä¸è¿ç»´)

---

## ç³»ç»Ÿæ¦‚è§ˆ

### äº§å“å®šä½

**SecureNotify** æ˜¯ä¸€ä¸ªä¸“æ³¨äº**ç«¯åˆ°ç«¯åŠ å¯†**çš„æ¨é€é€šçŸ¥æœåŠ¡ï¼Œæ—¨åœ¨ä¸ºåº”ç”¨ç¨‹åºæä¾›å®‰å…¨ã€å®æ—¶ã€å¯é çš„æ¶ˆæ¯åˆ†å‘èƒ½åŠ›ã€‚

### è®¾è®¡ç›®æ ‡

| ç›®æ ‡ | æè¿° |
|------|------|
| **å®‰å…¨æ€§** | ç«¯åˆ°ç«¯åŠ å¯†ï¼Œå¯†é’¥ç®¡ç†ï¼Œå®¡è®¡æ—¥å¿— |
| **å®æ—¶æ€§** | åŸºäº SSE çš„å®æ—¶æ¶ˆæ¯æ¨é€ |
| **å¯é æ€§** | æ¶ˆæ¯æŒä¹…åŒ–ï¼Œé‡è¿æœºåˆ¶ï¼Œä¼˜å…ˆçº§é˜Ÿåˆ— |
| **å¯æ‰©å±•æ€§** | æ°´å¹³æ‰©å±•ï¼Œæ”¯æŒé«˜å¹¶å‘ |
| **å¯è§‚æµ‹æ€§** | å®Œæ•´çš„æ—¥å¿—ã€ç›‘æ§ã€å®¡è®¡è¿½è¸ª |

### æ ¸å¿ƒæŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ |
|------|--------|
| æ¶ˆæ¯å»¶è¿Ÿ | < 100ms (ç«¯åˆ°ç«¯) |
| è¿æ¥ç¨³å®šæ€§ | 99.9% å¯ç”¨æ€§ |
| æ¶ˆæ¯æŒä¹…åŒ– | 12 å°æ—¶ |
| å¹¶å‘è¿æ¥æ•° | 10,000+ SSE è¿æ¥ |

---

## ç³»ç»Ÿæ¶æ„

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           SecureNotify æ¶æ„                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚   Client 1   â”‚     â”‚   Client 2   â”‚     â”‚   Client N   â”‚           â”‚
â”‚  â”‚  (Browser)   â”‚     â”‚  (Mobile)    â”‚     â”‚    (Other)   â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚         â”‚                    â”‚                    â”‚                     â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                              â”‚                                          â”‚
â”‚                              â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                      Next.js API Gateway                          â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚  â”‚
â”‚  â”‚  â”‚  CORS/Securityâ”‚  â”‚   Rate      â”‚  â”‚   Auth      â”‚               â”‚  â”‚
â”‚  â”‚  â”‚   Middleware â”‚  â”‚   Limiting  â”‚  â”‚   Middlewareâ”‚               â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                          â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚         â”‚                    â”‚                    â”‚                    â”‚
â”‚         â–¼                    â–¼                    â–¼                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚   /api/registerâ”‚   â”‚   /api/channelsâ”‚   â”‚   /api/publishâ”‚           â”‚
â”‚  â”‚  (å…¬é’¥æ³¨å†Œ)    â”‚   â”‚   (é¢‘é“ç®¡ç†)   â”‚   â”‚   (æ¶ˆæ¯å‘å¸ƒ)   â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚         â”‚                    â”‚                    â”‚                     â”‚
â”‚         â–¼                    â–¼                    â–¼                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                     ä¸šåŠ¡é€»è¾‘å±‚ (Services)                          â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚  â”‚
â”‚  â”‚  â”‚Encryption  â”‚ â”‚  Channel   â”‚ â”‚  Message   â”‚ â”‚   Audit    â”‚     â”‚  â”‚
â”‚  â”‚  â”‚   Service  â”‚ â”‚  Service   â”‚ â”‚  Service   â”‚ â”‚  Service   â”‚     â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                          â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚         â”‚                    â”‚                    â”‚                    â”‚
â”‚         â–¼                    â–¼                    â–¼                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                     æ•°æ®è®¿é—®å±‚ (Repositories)                      â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚  â”‚
â”‚  â”‚  â”‚ PublicKey  â”‚ â”‚  Channel   â”‚ â”‚  Message   â”‚ â”‚  ApiKey    â”‚     â”‚  â”‚
â”‚  â”‚  â”‚ Repository â”‚ â”‚ Repository â”‚ â”‚ Repository â”‚ â”‚ Repository â”‚     â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                          â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚         â–¼                    â–¼                    â–¼                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  PostgreSQL  â”‚     â”‚     Redis    â”‚     â”‚  Audit Logs  â”‚           â”‚
â”‚  â”‚  (ä¸»æ•°æ®åº“)   â”‚     â”‚  (ç¼“å­˜/é˜Ÿåˆ—)  â”‚     â”‚  (å­˜å‚¨)       â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åˆ†å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   API Gateway Layer                      â”‚
â”‚         (Next.js App Router + Middleware)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   Presentation Layer                     â”‚
â”‚              (API Routes / Request Handlers)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                  Business Logic Layer                    â”‚
â”‚              (Services / ä¸šåŠ¡é€»è¾‘)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                 Data Access Layer                        â”‚
â”‚            (Repositories / æ•°æ®è®¿é—®å¯¹è±¡)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                     Data Layer                           â”‚
â”‚         (PostgreSQL + Redis + File Storage)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¸å¿ƒç»„ä»¶

### 1. API Gateway

**æŠ€æœ¯æ ˆ**: Next.js 16 + TypeScript

**èŒè´£**:
- HTTP è¯·æ±‚è·¯ç”±
- è¯·æ±‚/å“åº”å¤„ç†
- ä¸­é—´ä»¶é›†æˆ (CORS, Security Headers)
- è®¤è¯/æˆæƒ

**å…³é”®é…ç½®**:
```typescript
// middleware.ts
export function middleware(request: NextRequest) {
  // CORS é…ç½®
  // å®‰å…¨å“åº”å¤´
  // è¯·æ±‚éªŒè¯
}
```

### 2. åŠ å¯†æœåŠ¡ (Encryption Service)

**ä½ç½®**: `src/lib/services/encryption/`

#### 2.1 RSA åŠ å¯†æœåŠ¡

```typescript
// rsa.service.ts
class RsaService {
  // ç”Ÿæˆ RSA å¯†é’¥å¯¹
  generateKey(keySize: number = 4096): KeyPair
  
  // å…¬é’¥åŠ å¯†
  encrypt(plaintext: string, publicKey: string): string
  
  // ç§é’¥è§£å¯†
  decrypt(ciphertext: string, privateKey: string): string
  
  // æ•°å­—ç­¾å
  sign(message: string, privateKey: string): string
  
  // ç­¾åéªŒè¯
  verify(signature: string, message: string, publicKey: string): boolean
}
```

**æ”¯æŒçš„ç®—æ³•**:
- RSA-2048 (é»˜è®¤)
- RSA-4096 (å¢å¼ºå®‰å…¨)
- ECC-SECP256K1 (æ¤­åœ†æ›²çº¿)

#### 2.2 AES åŠ å¯†æœåŠ¡

```typescript
// aes.service.ts
class AesService {
  // åŠ å¯† (AES-256-GCM)
  encrypt(plaintext: string, key?: Buffer): EncryptResult
  
  // è§£å¯†
  decrypt(ciphertext: string, iv: string, tag: string, key: Buffer): string
  
  // ç”Ÿæˆå¯†é’¥
  generateKey(): Buffer
}
```

**è§„æ ¼**:
- ç®—æ³•: AES-256-GCM
- å¯†é’¥é•¿åº¦: 32 å­—èŠ‚ (256 ä½)
- IV é•¿åº¦: 16 å­—èŠ‚ (128 ä½)
- è®¤è¯æ ‡ç­¾: 16 å­—èŠ‚

#### 2.3 æ··åˆåŠ å¯†æœåŠ¡

```typescript
// hybrid.service.ts
class HybridService {
  // åŠ å¯†å¤§æ¶ˆæ¯
  encrypt(
    message: string,
    recipientPublicKey: string
  ): HybridEncryptResult
  
  // è§£å¯†æ¶ˆæ¯
  decrypt(
    encryptedMessage: HybridEncryptResult,
    recipientPrivateKey: string
  ): string
}
```

**åŠ å¯†æµç¨‹**:
```
1. ç”Ÿæˆéšæœº AES-256 ä¼šè¯å¯†é’¥
2. ç”¨æ¥æ”¶è€…å…¬é’¥åŠ å¯† AES å¯†é’¥ (RSA-OAEP)
3. ç”¨ AES-GCM åŠ å¯†æ¶ˆæ¯å†…å®¹
4. è¿”å›: åŠ å¯†çš„ AES å¯†é’¥ + IV + æ ‡ç­¾ + å¯†æ–‡
```

### 3. æ¶ˆæ¯æœåŠ¡

**èŒè´£**:
- æ¶ˆæ¯å‘å¸ƒ
- æ¶ˆæ¯è®¢é˜… (SSE)
- æ¶ˆæ¯é˜Ÿåˆ—ç®¡ç†
- ä¼˜å…ˆçº§å¤„ç†

**æ¶ˆæ¯ä¼˜å…ˆçº§**:
```typescript
enum MessagePriority {
  CRITICAL = 100,  // ç«‹å³å¤„ç†
  HIGH = 75,       // é«˜ä¼˜å…ˆçº§
  NORMAL = 50,     // é»˜è®¤
  LOW = 25,        // ä½ä¼˜å…ˆçº§
  BULK = 0         // æ‰¹é‡
}
```

### 4. é¢‘é“æœåŠ¡

**èŒè´£**:
- é¢‘é“ CRUD æ“ä½œ
- é¢‘é“ç±»å‹ç®¡ç†
- è¿‡æœŸæ¸…ç†
- è‡ªåŠ¨åˆ›å»ºä¸´æ—¶é¢‘é“

**é¢‘é“ç±»å‹**:
| ç±»å‹ | å‰ç¼€ | åŠ å¯† | TTL |
|------|------|------|-----|
| å…¬å¼€ | `pub_` | âŒ | å¯é…ç½® |
| åŠ å¯† | `enc_` | âœ… | å¯é…ç½® |
| ä¸´æ—¶ | `tmp_` | âŒ/âœ… | 30 åˆ†é’Ÿ |

### 5. å¯†é’¥ç®¡ç†æœåŠ¡

**èŒè´£**:
- å…¬é’¥æ³¨å†Œ/æŸ¥è¯¢/æ’¤é”€
- API å¯†é’¥ç®¡ç†
- å¯†é’¥ç¼“å­˜
- å¯†é’¥è¿‡æœŸå¤„ç†
- **ä¸¤é˜¶æ®µæ’¤é”€ç¡®è®¤**
- **è½¯åˆ é™¤æœºåˆ¶**

**å¯†é’¥æ’¤é”€æµç¨‹** (ä¸¤é˜¶æ®µç¡®è®¤):

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   å¯†é’¥æ’¤é”€æµç¨‹                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  1. POST /api/keys/{keyId}/revoke                               â”‚
â”‚     â”œâ”€â”€ éªŒè¯ admin æƒé™                                         â”‚
â”‚     â”œâ”€â”€ éªŒè¯æ’¤é”€åŸå›  (æœ€å° 10 å­—ç¬¦)                              â”‚
â”‚     â”œâ”€â”€ ç”Ÿæˆç¡®è®¤ç  (PBKDF2 å“ˆå¸Œ, 64 å­—ç¬¦)                        â”‚
â”‚     â”œâ”€â”€ åˆ›å»ºæ’¤é”€ç¡®è®¤è®°å½• (24 å°æ—¶æœ‰æ•ˆæœŸ)                          â”‚
â”‚     â””â”€â”€ è¿”å›ç¡®è®¤ç  (ä»…æ­¤ä¸€æ¬¡)                                    â”‚
â”‚                                                                 â”‚
â”‚  2. ç­‰å¾…ç®¡ç†å‘˜ç¡®è®¤ (æœ€é•¿ 24 å°æ—¶)                                â”‚
â”‚     â”œâ”€â”€ ç¡®è®¤ç å¯è¢«å¤šæ¬¡éªŒè¯ (æœ€å¤š 5 æ¬¡)                            â”‚
â”‚     â”œâ”€â”€ 5 æ¬¡å¤±è´¥åé”å®š 1 å°æ—¶                                    â”‚
â”‚     â””â”€â”€ å¯éšæ—¶å–æ¶ˆæ’¤é”€è¯·æ±‚                                        â”‚
â”‚                                                                 â”‚
â”‚  3. DELETE /api/keys/{keyId}?confirmationCode=xxx               â”‚
â”‚     â”œâ”€â”€ éªŒè¯ç¡®è®¤ç æœ‰æ•ˆæ€§                                         â”‚
â”‚     â”œâ”€â”€ æ‰§è¡Œè½¯åˆ é™¤ (is_deleted = true)                           â”‚
â”‚     â”œâ”€â”€ è®°å½•å®¡è®¡æ—¥å¿— (åŒ…å«æ•°æ®å¿«ç…§)                               â”‚
â”‚     â””â”€â”€ é€šçŸ¥é¢‘é“è®¢é˜…è€…                                           â”‚
â”‚                                                                 â”‚
â”‚  4. æˆ– POST /api/keys/{keyId}/revoke/cancel                     â”‚
â”‚     â”œâ”€â”€ å–æ¶ˆå¾…ç¡®è®¤çš„æ’¤é”€è¯·æ±‚                                      â”‚
â”‚     â””â”€â”€ æ¸…é™¤æ’¤é”€ç¡®è®¤è®°å½•                                         â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è½¯åˆ é™¤æœºåˆ¶**:

| æ“ä½œ | æ•ˆæœ |
|------|------|
| æ’¤é”€å¯†é’¥ | `is_deleted = true`, `revoked_at = NOW()` |
| æŸ¥è¯¢å¯†é’¥ | é»˜è®¤æ’é™¤å·²åˆ é™¤å¯†é’¥ |
| æ¢å¤å¯†é’¥ | `is_deleted = false`, æ¸…é™¤æ’¤é”€æ ‡è®° |
| æ°¸ä¹…åˆ é™¤ | 30 å¤©åç”± Cron ä»»åŠ¡æ¸…ç† |

**å¯†é’¥ç¼“å­˜ç­–ç•¥** (Cache-Aside æ¨¡å¼):

```typescript
// key-cache.service.ts
class KeyCacheService {
  async get(publicKeyId: string): Promise<PublicKey | null> {
    // 1. å…ˆæŸ¥ Redis ç¼“å­˜
    const cached = await redis.get(`key:${publicKeyId}`);
    if (cached) return cached;
    
    // 2. ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥æ•°æ®åº“
    const key = await db.publicKeys.findById(publicKeyId);
    if (key && !key.isDeleted) {  // æ’é™¤å·²åˆ é™¤å¯†é’¥
      // 3. å†™å…¥ç¼“å­˜ (TTL: 7 å¤©)
      await redis.setex(`key:${publicKeyId}`, 604800, key);
    }
    return key;
  }
}
```

### 6. å®¡è®¡æ—¥å¿—æœåŠ¡

**èŒè´£**:
- æ“ä½œè®°å½•
- æ—¥å¿—å­˜å‚¨
- æ—¥å¿—æŸ¥è¯¢
- æ—¥å¿—æ¸…ç†

**å®¡è®¡æ—¥å¿—ç»“æ„**:
```typescript
interface AuditLog {
  id: UUID;
  createdAt: Date;
  action: string;        // key_register, key_revoke_request, key_revoke_confirmed, etc.
  channelId?: string;
  keyId?: string;
  messageId?: string;
  userId?: string;
  ip?: string;
  userAgent?: string;
  success: boolean;
  error?: string;
  metadata?: Record<string, unknown>;  // åŒ…å«åˆ é™¤å‰æ•°æ®å¿«ç…§
}
```

**å®¡è®¡åŠ¨ä½œç±»å‹**:

| åŠ¨ä½œç±»å‹ | è¯´æ˜ | å…ƒæ•°æ® |
|----------|------|--------|
| `key_register` | å…¬é’¥æ³¨å†Œ | algorithm, channelId |
| `key_revoke_request` | æ’¤é”€è¯·æ±‚å‘èµ· | reason (è„±æ•), expiresAt |
| `key_revoke_confirmed` | æ’¤é”€å·²ç¡®è®¤ | keySnapshot (æ•°æ®å¿«ç…§) |
| `key_revoke_cancelled` | æ’¤é”€å·²å–æ¶ˆ | - |
| `key_revoke_expired` | æ’¤é”€å·²è¿‡æœŸ | - |
| `auth_failure` | è®¤è¯å¤±è´¥ | attemptedAction |
| `message_publish` | æ¶ˆæ¯å‘å¸ƒ | priority, channelId |
| `channel_create` | é¢‘é“åˆ›å»º | type, creator |
| `cleanup_executed` | æ¸…ç†ä»»åŠ¡æ‰§è¡Œ | task, deletedCount |

---

## æ•°æ®æµç¨‹

### æ¶ˆæ¯å‘å¸ƒæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     æ¶ˆæ¯å‘å¸ƒæµç¨‹                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Client                                                          â”‚
â”‚    â”‚                                                            â”‚
â”‚    â–¼                                                            â”‚
â”‚  POST /api/publish                                               â”‚
â”‚    â”‚                                                            â”‚
â”‚    â–¼                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  1. è¯·æ±‚éªŒè¯ (Zod Schema Validation)                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚    â”‚                                                            â”‚
â”‚    â–¼                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  2. é€Ÿç‡é™åˆ¶æ£€æŸ¥ (Redis Counter)                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚    â”‚                                                            â”‚
â”‚    â”œâ”€ è¶…è¿‡é™åˆ¶ â”€â”€â†’ è¿”å› 429 Too Many Requests                  â”‚
â”‚    â”‚                                                            â”‚
â”‚    â–¼                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  3. è®¤è¯æ£€æŸ¥ (X-API-Key Header)                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚    â”‚                                                            â”‚
â”‚    â–¼                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  4. é¢‘é“éªŒè¯/åˆ›å»º                                           â”‚   â”‚
â”‚  â”‚     - æ£€æŸ¥é¢‘é“æ˜¯å¦å­˜åœ¨                                      â”‚   â”‚
â”‚  â”‚     - å¦‚æœ autoCreateï¼Œåˆ›å»ºä¸´æ—¶é¢‘é“                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚    â”‚                                                            â”‚
â”‚    â–¼                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  5. æ¶ˆæ¯åŠ å¯† (å¦‚æœ encrypted: true)                         â”‚   â”‚
â”‚  â”‚     - ä½¿ç”¨æ··åˆåŠ å¯† (RSA + AES-256-GCM)                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚    â”‚                                                            â”‚
â”‚    â–¼                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  6. æ¶ˆæ¯å­˜å‚¨                                               â”‚   â”‚
â”‚  â”‚     - å†™å…¥ Redis Sorted Set (æŒ‰ä¼˜å…ˆçº§æ’åº)                  â”‚   â”‚
â”‚  â”‚     - å‘å¸ƒåˆ° Redis Pub/Sub                                 â”‚   â”‚
â”‚  â”‚     - æŒä¹…åŒ–åˆ° PostgreSQL (å¦‚æœ cache: true)               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚    â”‚                                                            â”‚
â”‚    â–¼                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  7. å®¡è®¡æ—¥å¿—è®°å½•                                           â”‚   â”‚
â”‚  â”‚     - è®°å½•æ“ä½œç±»å‹ã€æ—¶é—´ã€ç»“æœ                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚    â”‚                                                            â”‚
â”‚    â–¼                                                            â”‚
â”‚  è¿”å› 201 Created ({ messageId, timestamp })                    â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å®æ—¶è®¢é˜…æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å®æ—¶è®¢é˜…æµç¨‹ (SSE)                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Client                                                          â”‚
â”‚    â”‚                                                            â”‚
â”‚    â–¼                                                            â”‚
â”‚  GET /api/subscribe?channel=my-channel                           â”‚
â”‚    â”‚                                                            â”‚
â”‚    â–¼                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  1. é¢‘é“éªŒè¯                                               â”‚   â”‚
â”‚  â”‚     - æ£€æŸ¥é¢‘é“æ˜¯å¦å­˜åœ¨                                      â”‚   â”‚
â”‚  â”‚     - æ£€æŸ¥é¢‘é“æ˜¯å¦è¿‡æœŸ                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚    â”‚                                                            â”‚
â”‚    â–¼                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  2. å»ºç«‹ SSE è¿æ¥                                          â”‚   â”‚
â”‚  â”‚     - è®¾ç½® Content-Type: text/event-stream                 â”‚   â”‚
â”‚  â”‚     - è®¾ç½® Cache-Control: no-cache                          â”‚   â”‚
â”‚  â”‚     - è®¾ç½® Connection: keep-alive                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚    â”‚                                                            â”‚
â”‚    â–¼                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  3. å‘é€è¿æ¥ç¡®è®¤                                           â”‚   â”‚
â”‚  â”‚     event: connected                                       â”‚   â”‚
â”‚  â”‚     data: {"channel": "my-channel", "status": "active"}    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚    â”‚                                                            â”‚
â”‚    â–¼                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  4. è®¢é˜… Redis Pub/Sub                                     â”‚   â”‚
â”‚  â”‚     SUBSCRIBE channel:my-channel                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚    â”‚                                                            â”‚
â”‚    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚    â”‚    â”‚                  æ¶ˆæ¯å¾ªç¯                          â”‚  â”‚
â”‚    â”‚    â”‚                                                   â”‚  â”‚
â”‚    â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚    â”‚    â”‚  â”‚ ç­‰å¾…æ–°æ¶ˆæ¯ (BLPOP)                            â”‚  â”‚  â”‚
â”‚    â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚    â”‚    â”‚                    â”‚                             â”‚  â”‚
â”‚    â”‚    â”‚                    â–¼                             â”‚  â”‚
â”‚    â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚    â”‚    â”‚  â”‚ å‘é€ SSE æ¶ˆæ¯                                 â”‚  â”‚  â”‚
â”‚    â”‚    â”‚  â”‚ event: message                               â”‚  â”‚  â”‚
â”‚    â”‚    â”‚  â”‚ id: msg_xxx                                  â”‚  â”‚  â”‚
â”‚    â”‚    â”‚  â”‚ data: {"id": "...", "message": "..."}        â”‚  â”‚  â”‚
â”‚    â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚    â”‚    â”‚                    â”‚                             â”‚  â”‚
â”‚    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚    â”‚                         â”‚                                  â”‚
â”‚    â”‚    å®šæ—¶ (æ¯ 30 ç§’)       â”‚ æ–°æ¶ˆæ¯                          â”‚
â”‚    â”‚                         â”‚                                  â”‚
â”‚    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚    â”‚    â”‚                                    â”‚                 â”‚
â”‚    â”‚    â–¼                                    â–¼                 â”‚
â”‚    â”‚  å‘é€ Keepalive                        å¤„ç†æ¶ˆæ¯            â”‚
â”‚    â”‚  : keepalive                                                   â”‚
â”‚    â”‚                                                               â”‚
â”‚    â”‚  å®¢æˆ·ç«¯æ–­å¼€è¿æ¥                                                 â”‚
â”‚    â”‚    â”‚                                                         â”‚
â”‚    â”‚    â–¼                                                         â”‚
â”‚    â”‚  æ¸…ç†èµ„æº (å…³é—­ Redis è¿æ¥)                                      â”‚
â”‚    â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å¯†é’¥æ³¨å†Œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å…¬é’¥æ³¨å†Œæµç¨‹                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Client                                                          â”‚
â”‚    â”‚                                                            â”‚
â”‚    â–¼                                                            â”‚
â”‚  POST /api/register                                               â”‚
â”‚    â”‚                                                            â”‚
â”‚    â–¼                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  1. è¯·æ±‚éªŒè¯                                               â”‚   â”‚
â”‚  â”‚     - éªŒè¯ publicKey æ ¼å¼ (PEM)                            â”‚   â”‚
â”‚  â”‚     - éªŒè¯ algorithm å‚æ•°                                   â”‚   â”‚
â”‚  â”‚     - éªŒè¯ expiresIn èŒƒå›´                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚    â”‚                                                            â”‚
â”‚    â–¼                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  2. ç”Ÿæˆé¢‘é“ ID                                             â”‚   â”‚
â”‚  â”‚     - æ ¼å¼: enc_{hash}                                     â”‚   â”‚
â”‚  â”‚     - ç¡®ä¿å”¯ä¸€æ€§                                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚    â”‚                                                            â”‚
â”‚    â–¼                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  3. å­˜å‚¨å…¬é’¥                                               â”‚   â”‚
â”‚  â”‚     - å†™å…¥ PostgreSQL public_keys è¡¨                       â”‚   â”‚
â”‚  â”‚     - åˆ›å»ºé¢‘é“è®°å½• (channels è¡¨)                           â”‚   â”‚
â”‚  â”‚     - è®¾ç½®è¿‡æœŸæ—¶é—´                                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚    â”‚                                                            â”‚
â”‚    â–¼                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  4. åˆå§‹åŒ–ç¼“å­˜                                             â”‚   â”‚
â”‚  â”‚     - å†™å…¥ Redis ç¼“å­˜ (TTL: 7 å¤©)                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚    â”‚                                                            â”‚
â”‚    â–¼                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  5. å®¡è®¡è®°å½•                                               â”‚   â”‚
â”‚  â”‚     - è®°å½• key_register æ“ä½œ                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚    â”‚                                                            â”‚
â”‚    â–¼                                                            â”‚
â”‚  è¿”å› 201 Created                                               â”‚
â”‚  {                                                              â”‚
â”‚    "success": true,                                             â”‚
â”‚    "data": {                                                    â”‚
â”‚      "channelId": "enc_xxx",                                    â”‚
â”‚      "publicKeyId": "uuid",                                     â”‚
â”‚      "algorithm": "RSA-4096",                                   â”‚
â”‚      "expiresAt": "...",                                        â”‚
â”‚      "expiresIn": 604800                                        â”‚
â”‚    }                                                            â”‚
â”‚  }                                                              â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å®‰å…¨æ€§è®¾è®¡

### åŠ å¯†ä½“ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      åŠ å¯†å±‚æ¬¡ç»“æ„                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Layer 1: ä¼ è¾“åŠ å¯†                                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                              â”‚
â”‚  â€¢ HTTPS/TLS 1.3                                                â”‚
â”‚  â€¢ è¯ä¹¦éªŒè¯                                                      â”‚
â”‚  â€¢ å®‰å…¨çš„ TLS é…ç½®                                               â”‚
â”‚                                                                 â”‚
â”‚  Layer 2: åº”ç”¨å±‚åŠ å¯†                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                          â”‚
â”‚  â€¢ ç«¯åˆ°ç«¯åŠ å¯† (E2EE)                                             â”‚
â”‚  â€¢ æ··åˆåŠ å¯† (RSA + AES-256-GCM)                                 â”‚
â”‚  â€¢ æ•°å­—ç­¾å                                                      â”‚
â”‚                                                                 â”‚
â”‚  Layer 3: æ•°æ®å­˜å‚¨åŠ å¯†                                           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                          â”‚
â”‚  â€¢ æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨                                               â”‚
â”‚  â€¢ å¯†é’¥å“ˆå¸Œå­˜å‚¨                                                   â”‚
â”‚  â€¢ å†…å­˜ä¸­çš„å¯†é’¥ä¿æŠ¤                                               â”‚
â”‚                                                                 â”‚
â”‚  Layer 4: è®¿é—®æ§åˆ¶                                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                              â”‚
â”‚  â€¢ API å¯†é’¥è®¤è¯                                                  â”‚
â”‚  â€¢ æƒé™æ§åˆ¶                                                      â”‚
â”‚  â€¢ IP ç™½åå•                                                    â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è®¤è¯æœºåˆ¶

```typescript
// è®¤è¯æµç¨‹
async function authenticate(request: Request): Promise<AuthResult> {
  // 1. æ£€æŸ¥ X-API-Key
  const apiKey = request.headers.get('X-API-Key');
  if (apiKey) {
    return validateApiKey(apiKey);
  }
  
  // 2. æ£€æŸ¥ X-Admin-Key
  const adminKey = request.headers.get('X-Admin-Key');
  if (adminKey) {
    return validateAdminKey(adminKey);
  }
  
  // 3. æ£€æŸ¥ Cron Secret
  const cronSecret = request.headers.get('X-Cron-Secret');
  if (cronSecret) {
    return validateCronSecret(cronSecret);
  }
  
  // 4. æ— è®¤è¯çš„å…¬å¼€ç«¯ç‚¹
  return { authenticated: false, userId: null };
}
```

### é€Ÿç‡é™åˆ¶

```typescript
// å¤šå±‚é€Ÿç‡é™åˆ¶
class RateLimiter {
  // åŸºäº IP çš„ä¸¥æ ¼é™åˆ¶
  async checkIpLimit(ip: string, limit: number, window: number): Promise<boolean>
  
  // åŸºäº User-Agent çš„å®½æ¾é™åˆ¶
  async checkUaLimit(uaHash: string, limit: number, window: number): Promise<boolean>
  
  // ç»„åˆæ£€æŸ¥
  async checkPublishLimit(request: Request): Promise<boolean> {
    const ip = this.getClientIp(request);
    const uaHash = this.hashUserAgent(request.headers.get('user-agent'));
    
    return (
      await this.checkIpLimit(ip, 10, 60) &&  // ä¸¥æ ¼: 10æ¬¡/åˆ†é’Ÿ
      await this.checkUaLimit(uaHash, 20, 60) // å®½æ¾: 20æ¬¡/åˆ†é’Ÿ
    );
  }
}
```

#### LRU  Eviction å†…å­˜ä¿æŠ¤

```typescript
// RateLimitStore LRU  eviction å®ç°
class RateLimitStore {
  private store: Map<string, { count: number; windowStart: number }>;
  private maxEntries: number = 10000;  // æœ€å¤§æ¡ç›®æ•°
  
  // æ£€æŸ¥é™åˆ¶
  async check(key: string, limit: number, windowMs: number): Promise<boolean> {
    const now = Date.now();
    let entry = this.store.get(key);
    
    if (!entry) {
      entry = { count: 0, windowStart: now };
    }
    
    // çª—å£è¿‡æœŸï¼Œé‡ç½®
    if (now - entry.windowStart > windowMs) {
      entry = { count: 0, windowStart: now };
    }
    
    entry.count++;
    
    // LRU evictionï¼šå¦‚æœå­˜å‚¨å·²æ»¡ï¼Œåˆ é™¤æœ€æ—§çš„æ¡ç›®
    if (this.store.size >= this.maxEntries) {
      this.evictOldest();
    }
    
    this.store.set(key, entry);
    
    return entry.count <= limit;
  }
  
  // æ¸…ç†æœ€ä¹…æœªä½¿ç”¨çš„æ¡ç›®
  private evictOldest(): void {
    const oldestKey = this.store.keys().next().value;
    this.store.delete(oldestKey);
  }
}
```

**å†…å­˜ä¿æŠ¤ç‰¹æ€§**ï¼š

- æœ€å¤§å­˜å‚¨ 10,000 ä¸ªé™æµæ¡ç›®
- è‡ªåŠ¨ LRU  eviction é˜²æ­¢å†…å­˜æ³„æ¼
- é«˜å¹¶å‘åœºæ™¯ä¸‹ä»èƒ½ä¿æŒç¨³å®šå†…å­˜ä½¿ç”¨

### CRON_SECRET éªŒè¯å¢å¼º

```typescript
// CRON_SECRET éªŒè¯æµç¨‹
class CronSecretValidator {
  // é»˜è®¤/å ä½ç¬¦æ£€æµ‹
  private forbiddenDefaults = [
    'cron-secret',
    'default',
    'changeme',
    'secret',
    'admin',
    '12345678'
  ];
  
  async validate(secret: string): Promise<ValidationResult> {
    // 1. é•¿åº¦æ£€æŸ¥ï¼šæœ€å°‘ 32 å­—ç¬¦
    if (secret.length < 32) {
      return { valid: false, reason: 'CRON_SECRET must be at least 32 characters' };
    }
    
    // 2. é»˜è®¤å€¼æ£€æµ‹
    if (this.forbiddenDefaults.some(d => secret.toLowerCase().includes(d))) {
      return { valid: false, reason: 'CRON_SECRET cannot be a default or placeholder value' };
    }
    
    // 3. å®šæ—¶å®‰å…¨çš„æ¯”è¾ƒï¼ˆå¦‚æœæœ‰å·²å­˜å‚¨çš„å“ˆå¸Œï¼‰
    if (this.storedHash) {
      const isMatch = await this.timingSafeCompare(secret, this.storedHash);
      if (!isMatch) {
        return { valid: false, reason: 'Invalid CRON_SECRET' };
      }
    }
    
    return { valid: true };
  }
  
  // å®šæ—¶å®‰å…¨çš„å­—ç¬¦ä¸²æ¯”è¾ƒï¼ˆé˜²æ­¢æ—¶åºæ”»å‡»ï¼‰
  private async timingSafeCompare(a: string, b: string): Promise<boolean> {
    if (a.length !== b.length) return false;
    const aBuf = Buffer.from(a);
    const bBuf = Buffer.from(b);
    return crypto.timingSafeEqual(aBuf, bBuf);
  }
}
```

**éªŒè¯å¢å¼ºç‰¹æ€§**ï¼š

- å¼ºåˆ¶æœ€å°é•¿åº¦ï¼š32 å­—ç¬¦
- é»˜è®¤å€¼/å ä½ç¬¦æ£€æµ‹
- å®šæ—¶å®‰å…¨çš„æ¯”è¾ƒï¼ˆé˜²æ­¢æ—¶åºæ”»å‡»ï¼‰
- ç”Ÿäº§ç¯å¢ƒå¼ºåˆ¶éªŒè¯ï¼ˆä¸ä»…æ˜¯å¼€å‘ç¯å¢ƒï¼‰

### ä¼˜é›…å…³é—­å¤„ç†

```typescript
// graceful-shutdown.ts
interface ShutdownHandler {
  // å…³é—­ä¿¡å·å¤„ç†
  setupGracefulShutdown(): void;
  
  // å…³é—­æ•°æ®åº“è¿æ¥
  closeDatabase(): Promise<void>;
  
  // å…³é—­ Redis è¿æ¥
  closeRedis(): Promise<void>;
  
  // æ¸…ç†èµ„æº
  cleanup(): void;
}

class GracefulShutdown implements ShutdownHandler {
  private readonly SHUTDOWN_TIMEOUT = 30000; // 30 ç§’
  
  setupGracefulShutdown(): void {
    // æ•è·ç³»ç»Ÿä¿¡å·
    process.on('SIGTERM', () => this.handleShutdown('SIGTERM'));
    process.on('SIGINT', () => this.handleShutdown('SIGINT'));
    
    // æ•è·æœªå¤„ç†å¼‚å¸¸
    process.on('uncaughtException', (error) => {
      console.error('Uncaught Exception:', error);
      this.handleShutdown('uncaughtException');
    });
    
    // æ•è·æœªå¤„ç†çš„ Promise æ‹’ç»
    process.on('unhandledRejection', (reason) => {
      console.error('Unhandled Rejection:', reason);
      this.handleShutdown('unhandledRejection');
    });
  }
  
  private async handleShutdown(signal: string): Promise<void> {
    console.log(`Received ${signal}, starting graceful shutdown...`);
    
    // 1. è®¾ç½®å…³é—­æ ‡å¿—ï¼Œåœæ­¢æ¥å—æ–°è¯·æ±‚
    this.acceptingRequests = false;
    
    // 2. ç­‰å¾…ç°æœ‰è¯·æ±‚å®Œæˆ
    await this.waitForRequestsToComplete(this.SHUTDOWN_TIMEOUT);
    
    // 3. å…³é—­æ•°æ®åº“è¿æ¥æ± 
    await this.closeDatabase();
    
    // 4. å…³é—­ Redis è¿æ¥
    await this.closeRedis();
    
    console.log('Graceful shutdown completed');
    process.exit(0);
  }
}
```

**ä¼˜é›…å…³é—­ç‰¹æ€§**ï¼š

- æ•è· `SIGTERM`ã€`SIGINT`ã€`uncaughtException`ã€`unhandledRejection`
- æœ€å¤§ 30 ç§’ç­‰å¾…æ—¶é—´
- ç¡®ä¿æ•°æ®åº“è¿æ¥æ­£ç¡®å…³é—­
- é˜²æ­¢æ•°æ®ä¸¢å¤±

### å®‰å…¨å“åº”å¤´

```typescript
// middleware.ts - å®‰å…¨å“åº”å¤´é…ç½®
const securityHeaders = {
  'X-DNS-Prefetch-Control': 'off',
  'Strict-Transport-Security': 'max-age=63072000; includeSubDomains; preload',
  'X-Content-Type-Options': 'nosniff',
  'X-Frame-Options': 'DENY',
  'X-XSS-Protection': '1; mode=block',
  'Referrer-Policy': 'origin-when-cross-origin',
  'Content-Security-Policy': "default-src 'self'"
};
```

### å®¡è®¡æ—¥å¿—

```typescript
// å®¡è®¡æ—¥å¿—è®°å½•
await auditService.log({
  action: 'message_publish',
  channelId: 'my-channel',
  userId: 'user-123',
  ip: request.ip,
  userAgent: request.headers.get('user-agent'),
  success: true,
  metadata: { messageId: 'msg_xxx', priority: 'normal' }
});
```

---

## æŠ€æœ¯å†³ç­–

### æ•°æ®åº“é€‰æ‹©

| ç»„ä»¶ | é€‰æ‹© | åŸå›  |
|------|------|------|
| **ä¸»æ•°æ®åº“** | PostgreSQL 14+ | å¯é æ€§ã€ACID äº‹åŠ¡ã€JSON æ”¯æŒ |
| **ç¼“å­˜/æ¶ˆæ¯** | Redis 7+ | é«˜æ€§èƒ½ã€Pub/Subã€Sorted Sets |
| **ORM** | Drizzle ORM | è½»é‡çº§ã€ç±»å‹å®‰å…¨ã€é›¶ä¾èµ– |

### æ¶ˆæ¯é˜Ÿåˆ—è®¾è®¡

```typescript
// ä¼˜å…ˆçº§é˜Ÿåˆ—å®ç°
// ä½¿ç”¨ Redis Sorted Setï¼Œscore ä¸ºä¼˜å…ˆçº§å€¼
await redis.zadd(
  `channel:${channelId}:messages`,
  {
    [messageId]: priority,  // CRITICAL=100, HIGH=75, NORMAL=50, LOW=25, BULK=0
    [data]: messageData
  }
);

// æŒ‰ä¼˜å…ˆçº§å–æ¶ˆæ¯
await redis.zrevrange(
  `channel:${channelId}:messages`,
  0,
  count - 1  // å–æœ€é«˜ä¼˜å…ˆçº§çš„æ¶ˆæ¯
);
```

### å®æ—¶é€šä¿¡

```typescript
// Server-Sent Events (SSE) ä¼˜äº WebSocket çš„åŸå› 
const sseAdvantages = [
  'è‡ªåŠ¨é‡è¿æ”¯æŒ',
  'ç®€å•åè®® (HTTP)',
  'é˜²ç«å¢™å‹å¥½',
  'å•å‘é€šä¿¡ (æ›´é€‚åˆæ¨é€)',
  'æµè§ˆå™¨åŸç”Ÿæ”¯æŒ'
];

// å¤‡é€‰æ–¹æ¡ˆï¼šRedis Pub/Sub
// ç”¨äºå¤šå®ä¾‹é—´çš„æ¶ˆæ¯åˆ†å‘
await redis.subscribe(`channel:${channelId}`, (message) => {
  // å¹¿æ’­åˆ°æ‰€æœ‰è®¢é˜…è€…
});
```

### å¯†é’¥å­˜å‚¨ç­–ç•¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å¯†é’¥å­˜å‚¨å±‚æ¬¡                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  çƒ­æ•°æ® (é¢‘ç¹è®¿é—®)                                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                              â”‚
â”‚  Redis Cache (7 å¤© TTL)                                         â”‚
â”‚  â€¢ å…¬é’¥æŸ¥è¯¢                                                     â”‚
â”‚  â€¢ API å¯†é’¥éªŒè¯                                                 â”‚
â”‚                                                                 â”‚
â”‚  æ¸©æ•°æ® (æŒä¹…å­˜å‚¨)                                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                              â”‚
â”‚  PostgreSQL                                                     â”‚
â”‚  â€¢ å…¬é’¥ (public_keys è¡¨)                                        â”‚
â”‚  â€¢ API å¯†é’¥ (api_keys è¡¨ - å“ˆå¸Œå­˜å‚¨)                            â”‚
â”‚  â€¢ é¢‘é“å…ƒæ•°æ®                                                   â”‚
â”‚                                                                 â”‚
â”‚  å†·æ•°æ® (å½’æ¡£)                                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                  â”‚
â”‚  å®¡è®¡æ—¥å¿— (90 å¤©ä¿ç•™)                                           â”‚
â”‚  è¿‡æœŸæ¶ˆæ¯                                                       â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ€§èƒ½è€ƒè™‘

### æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡ | å½“å‰å®ç° |
|------|------|----------|
| API å“åº”æ—¶é—´ | P95 < 100ms | ~50ms |
| æ¶ˆæ¯æ¨é€å»¶è¿Ÿ | < 50ms | ~20ms |
| SSE è¿æ¥å»ºç«‹ | < 200ms | ~100ms |
| å¹¶å‘è¿æ¥æ•° | 10,000+ | å—é™äºå•å®ä¾‹ |
| æ¶ˆæ¯ååé‡ | 1,000 msg/s | å¯æ°´å¹³æ‰©å±• |

### ä¼˜åŒ–ç­–ç•¥

```typescript
// 1. è¿æ¥æ± é…ç½®
const poolConfig = {
  min: 5,
  max: 20,
  idleTimeout: 30000,
  connectionTimeoutMillis: 5000
};

// 2. Redis è¿æ¥å¤ç”¨
const redis = createRedisClient({
  maxRetriesPerRequest: 3,
  enableReadyCheck: true,
  lazyConnect: true
});

// 3. æ‰¹å¤„ç†ä¼˜åŒ–
async function batchProcess(items: Item[]) {
  const batchSize = 100;
  const batches = chunk(items, batchSize);
  
  for (const batch of batches) {
    await Promise.all(batch.map(item => process(item)));
  }
}

// 4. ç¼“å­˜ç­–ç•¥
// å…¬é’¥ç¼“å­˜ 7 å¤©
// é¢‘é“ä¿¡æ¯ç¼“å­˜ 1 å°æ—¶
// API å¯†é’¥éªŒè¯ç»“æœç¼“å­˜ 5 åˆ†é’Ÿ
```

#### KeyRevocationService æƒé™æ£€æŸ¥å¹¶è¡ŒåŒ–

```typescript
// ä¼˜åŒ–å‰ï¼šé¡ºåºæ£€æŸ¥
class KeyRevocationServiceBefore {
  async checkPermissions(keyId: string, request: Request): Promise<boolean> {
    const apiKey = await this.getApiKey(request);           // ç­‰å¾… 20ms
    const hasAdmin = await this.checkAdminPermission(apiKey); // ç­‰å¾… 15ms
    const keyExists = await this.verifyKeyExists(keyId);      // ç­‰å¾… 10ms
    const notRevoked = await this.checkNotRevoked(keyId);     // ç­‰å¾… 10ms
    
    return hasAdmin && keyExists && notRevoked;  // æ€»å»¶è¿Ÿï¼š~55ms
  }
}

// ä¼˜åŒ–åï¼šå¹¶è¡Œæ£€æŸ¥
class KeyRevocationServiceOptimized {
  async checkPermissions(keyId: string, request: Request): Promise<boolean> {
    const apiKey = await this.getApiKey(request);
    
    // å¹¶è¡Œæ‰§è¡Œæ‰€æœ‰æƒé™æ£€æŸ¥
    const [hasAdmin, keyExists, notRevoked] = await Promise.all([
      this.checkAdminPermission(apiKey),
      this.verifyKeyExists(keyId),
      this.checkNotRevoked(keyId)
    ]);
    
    return hasAdmin && keyExists && notRevoked;  // æ€»å»¶è¿Ÿï¼š~20ms
  }
}
```

**å¹¶è¡ŒåŒ–æ”¶ç›Š**ï¼š

| åœºæ™¯ | ä¼˜åŒ–å‰å»¶è¿Ÿ | ä¼˜åŒ–åå»¶è¿Ÿ | æå‡ |
|------|-----------|-----------|------|
| å•æ¬¡æ’¤é”€è¯·æ±‚ | ~55ms | ~20ms | **64%** |
| æ‰¹é‡æ’¤é”€ï¼ˆ100 ä¸ªï¼‰ | 5.5s | 2.0s | **64%** |
| é«˜å¹¶å‘åœºæ™¯ | ç“¶é¢ˆæ˜æ˜¾ | ç¨³å®šæ€§èƒ½ | **ç¨³å®šæ€§æå‡** |

é€šè¿‡å¹¶è¡ŒåŒ–æƒé™æ£€æŸ¥ï¼Œæ˜¾è‘—é™ä½äº†å¯†é’¥æ’¤é”€æ“ä½œçš„å»¶è¿Ÿï¼Œæå‡äº†ç³»ç»Ÿæ•´ä½“ååé‡ã€‚

### ç“¶é¢ˆåˆ†æ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ€§èƒ½ç“¶é¢ˆåˆ†æ                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  æ•°æ®åº“æŸ¥è¯¢                                                      â”‚
â”‚  â”œâ”€ å…¬é’¥æŸ¥è¯¢: è¯»å¤šå†™å°‘ï¼Œä¸»è¦è¯» Redis ç¼“å­˜                         â”‚
â”‚  â”œâ”€ é¢‘é“åˆ›å»º: å†™æ“ä½œï¼Œéœ€è¦å”¯ä¸€æ€§æ£€æŸ¥                              â”‚
â”‚  â””â”€ æ¶ˆæ¯å­˜å‚¨: æ‰¹é‡å†™å…¥ï¼Œä¼˜åŒ–æ‰¹æ¬¡å¤§å°                              â”‚
â”‚                                                                 â”‚
â”‚  Redis æ“ä½œ                                                      â”‚
â”‚  â”œâ”€ Pub/Sub: é«˜é¢‘ï¼Œä½†å»¶è¿Ÿä½                                      â”‚
â”‚  â”œâ”€ Sorted Set: ä¼˜å…ˆçº§æ’åºï¼ŒO(log N)                             â”‚
â”‚  â””â”€ ç¼“å­˜å¤±æ•ˆ: éœ€è¦æ³¨æ„ç¼“å­˜å‡»ç©¿                                    â”‚
â”‚                                                                 â”‚
â”‚  ç½‘ç»œä¼ è¾“                                                        â”‚
â”‚  â”œâ”€ SSE è¿æ¥: é•¿è¿æ¥ï¼Œèµ„æºå ç”¨                                   â”‚
â”‚  â”œâ”€ æ¶ˆæ¯åŠ å¯†: CPU å¯†é›†å‹ï¼Œå¯è€ƒè™‘ç¡¬ä»¶åŠ é€Ÿ                          â”‚
â”‚  â””â”€ TLS å¼€é”€: ä½¿ç”¨ TLS 1.3 ä¼˜åŒ–                                  â”‚
â”‚                                                                 â”‚
â”‚  å†…å­˜ä½¿ç”¨                                                        â”‚
â”‚  â”œâ”€ SSE è¿æ¥: æ¯ä¸ªè¿æ¥çº¦ 1KB                                     â”‚
â”‚  â”œâ”€ æ¶ˆæ¯é˜Ÿåˆ—: éœ€è¦é™åˆ¶é˜Ÿåˆ—é•¿åº¦                                    â”‚
â”‚  â””â”€ ç¼“å­˜: é…ç½®åˆç†çš„ TTL å’Œæœ€å¤§å†…å­˜                              â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å¯æ‰©å±•æ€§

### æ°´å¹³æ‰©å±•æ¶æ„

```
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚   Load Balancer â”‚
                           â”‚   (Nginx/Cloud) â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                     â”‚                     â”‚
              â–¼                     â–¼                     â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚  Next.js Node 1 â”‚  â”‚  Next.js Node 2 â”‚  â”‚  Next.js Node N â”‚
     â”‚   (Instance)    â”‚  â”‚   (Instance)    â”‚  â”‚   (Instance)    â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                     â”‚                     â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                     â”‚                     â”‚
              â–¼                     â–¼                     â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚   PostgreSQL    â”‚  â”‚   PostgreSQL    â”‚  â”‚   PostgreSQL    â”‚
     â”‚   (Primary)     â”‚  â”‚    (Replica)    â”‚  â”‚    (Replica)    â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚   Redis Master  â”‚  â”‚   Redis Slave   â”‚  â”‚   Redis Slave   â”‚
     â”‚                 â”‚  â”‚  (Read Replica) â”‚  â”‚  (Read Replica) â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ‰©å±•ç­–ç•¥

| æ‰©å±•ç»´åº¦ | ç­–ç•¥ |
|----------|------|
| **è®¡ç®—å±‚** | æ— çŠ¶æ€ Next.js å®ä¾‹ï¼ŒKubernetes HPA è‡ªåŠ¨æ‰©ç¼©å®¹ |
| **æ•°æ®åº“å±‚** | PostgreSQL ä¸»ä»å¤åˆ¶ + è¿æ¥æ± åˆ†ç‰‡ |
| **ç¼“å­˜å±‚** | Redis é›†ç¾¤ + Sentinel é«˜å¯ç”¨ |
| **æ¶ˆæ¯å±‚** | Redis Pub/Sub + å¤šæ¶ˆè´¹è€…ç»„ |
| **CDN** | é™æ€èµ„æºé€šè¿‡ CDN åˆ†å‘ |

### åˆ†ç‰‡ç­–ç•¥

```typescript
// åŸºäºé¢‘é“ ID çš„åˆ†ç‰‡
function getShardId(channelId: string): number {
  const hash = crypto.createHash('md5').update(channelId).digest('hex');
  const shardNum = parseInt(hash.substring(0, 2), 16) % SHARD_COUNT;
  return shardNum;
}

// åˆ†ç‰‡é…ç½®
const SHARD_CONFIG = {
  count: 4,
  replicaCount: 2,
  shardingKey: 'channelId'
};
```

---

## ç›‘æ§ä¸è¿ç»´

### ç›‘æ§æŒ‡æ ‡

```typescript
// å…³é”®æŒ‡æ ‡å®šä¹‰
const metrics = {
  // API æŒ‡æ ‡
  api: {
    requests: 'counter',      // è¯·æ±‚æ€»æ•°
    latency: 'histogram',      // å“åº”å»¶è¿Ÿ
    errors: 'counter',         // é”™è¯¯æ•°
    rateLimitHits: 'counter'   // é™æµæ¬¡æ•°
  },
  
  // æ¶ˆæ¯æŒ‡æ ‡
  messages: {
    published: 'counter',      // å‘å¸ƒæ¶ˆæ¯æ•°
    delivered: 'counter',      // æ¨é€æ¶ˆæ¯æ•°
    failed: 'counter',         // å¤±è´¥æ¶ˆæ¯æ•°
    queueLength: 'gauge',      // é˜Ÿåˆ—é•¿åº¦
    priority: 'histogram'      // ä¼˜å…ˆçº§åˆ†å¸ƒ
  },
  
  // è¿æ¥æŒ‡æ ‡
  connections: {
    active: 'gauge',           // æ´»è·ƒè¿æ¥æ•°
    reconnect: 'counter',      // é‡è¿æ¬¡æ•°
    disconnected: 'counter'    // æ–­å¼€è¿æ¥æ•°
  },
  
  // ç³»ç»ŸæŒ‡æ ‡
  system: {
    cpu: 'gauge',              // CPU ä½¿ç”¨ç‡
    memory: 'gauge',           // å†…å­˜ä½¿ç”¨ç‡
    disk: 'gauge',             // ç£ç›˜ä½¿ç”¨ç‡
    network: 'gauge'           // ç½‘ç»œå¸¦å®½
  }
};
```

### æ—¥å¿—ç­–ç•¥

```typescript
// æ—¥å¿—çº§åˆ«é…ç½®
const LOG_LEVELS = {
  development: 'debug',
  staging: 'info',
  production: 'warn'
};

// æ—¥å¿—ç»“æ„
interface LogEntry {
  timestamp: string;
  level: 'debug' | 'info' | 'warn' | 'error';
  service: string;
  action: string;
  message: string;
  metadata?: Record<string, unknown>;
  error?: {
    name: string;
    message: string;
    stack?: string;
  };
}

// å®¡è®¡æ—¥å¿— (ç‹¬ç«‹å­˜å‚¨)
const auditLog = {
  retention: '90d',
  storage: 'database',  // PostgreSQL audit_logs è¡¨
  indexing: ['action', 'channelId', 'createdAt']
};
```

### å¥åº·æ£€æŸ¥

```typescript
// /api/cron/health ç«¯ç‚¹
async function healthCheck(): Promise<HealthStatus> {
  const checks = {
    database: await checkDatabase(),
    redis: await checkRedis(),
    storage: await checkStorage(),
    queue: await checkMessageQueue()
  };
  
  const isHealthy = Object.values(checks).every(check => check.status === 'healthy');
  
  return {
    status: isHealthy ? 'healthy' : 'degraded',
    timestamp: new Date().toISOString(),
    uptime: process.uptime(),
    checks
  };
}
```

### å‘Šè­¦è§„åˆ™

```yaml
# å‘Šè­¦é…ç½®ç¤ºä¾‹
alerts:
  - name: API High Error Rate
    condition: error_rate > 5% for 5 minutes
    severity: warning
    action: page_oncall
    
  - name: SSE Connection Drop
    condition: disconnect_rate > 10% for 1 minute
    severity: warning
    action: notify_slack
    
  - name: Message Queue Backlog
    condition: queue_length > 1000 for 10 minutes
    severity: critical
    action: page_oncall
    
  - name: Database Connection Pool
    condition: connection_usage > 80% for 5 minutes
    severity: warning
    action: notify_slack
```

---

## æ€»ç»“

### æ¶æ„ä¼˜åŠ¿

| ä¼˜åŠ¿ | è¯´æ˜ |
|------|------|
| **æ¨¡å—åŒ–** | åˆ†å±‚æ¶æ„ï¼ŒèŒè´£æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤ |
| **å®‰å…¨æ€§** | å¤šå±‚åŠ å¯†ï¼Œå®Œæ•´çš„è®¤è¯æˆæƒä½“ç³» |
| **å¯æ‰©å±•** | æ— çŠ¶æ€è®¾è®¡ï¼Œæ”¯æŒæ°´å¹³æ‰©å±• |
| **å¯é æ€§** | æ¶ˆæ¯æŒä¹…åŒ–ï¼Œé‡è¯•æœºåˆ¶ï¼Œæ•…éšœè½¬ç§» |
| **å¯è§‚æµ‹** | å®Œæ•´çš„æ—¥å¿—ã€æŒ‡æ ‡ã€ç›‘æ§ |

### æŠ€æœ¯æ ˆæ€»ç»“

| ç»„ä»¶ | æŠ€æœ¯é€‰æ‹© |
|------|----------|
| å‰ç«¯æ¡†æ¶ | Next.js 16 + TypeScript |
| æ•°æ®åº“ | PostgreSQL 14+ |
| ç¼“å­˜ | Redis 7+ |
| ORM | Drizzle ORM |
| éªŒè¯ | Zod |
| æµ‹è¯• | Vitest |
| éƒ¨ç½² | Vercel / Docker |

### æ¼”è¿›è·¯çº¿

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æŠ€æœ¯æ¼”è¿›è·¯çº¿                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Phase 1: åŸºç¡€åŠŸèƒ½ (å½“å‰)                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                   â”‚
â”‚  âœ“ ç«¯åˆ°ç«¯åŠ å¯†                                                   â”‚
â”‚  âœ“ SSE å®æ—¶æ¨é€                                                 â”‚
â”‚  âœ“ æ¶ˆæ¯ä¼˜å…ˆçº§                                                   â”‚
â”‚  âœ“ å®¡è®¡æ—¥å¿—                                                     â”‚
â”‚                                                                 â”‚
â”‚  Phase 2: å¢å¼ºåŠŸèƒ½ (è§„åˆ’ä¸­)                                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                     â”‚
â”‚  â—‹ Webhooks é€šçŸ¥                                                 â”‚
â”‚  â—‹ æ¶ˆæ¯ç¡®è®¤æœºåˆ¶                                                 â”‚
â”‚  â—‹ æ¶ˆæ¯å†å²æ£€ç´¢                                                 â”‚
â”‚  â—‹ å¤šç§Ÿæˆ·æ”¯æŒ                                                   â”‚
â”‚                                                                 â”‚
â”‚  Phase 3: é«˜çº§åŠŸèƒ½ (æœªæ¥)                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                         â”‚
â”‚  â—‹ æ¶ˆæ¯ç«¯åˆ°ç«¯ç¡®è®¤                                               â”‚
â”‚  â—‹ ç¦»çº¿æ¶ˆæ¯æ¨é€                                                 â”‚
â”‚  â—‹ æ¶ˆæ¯åŠ å¯†å¯†é’¥è½®æ¢                                             â”‚
â”‚  â—‹ åˆ†å¸ƒå¼è¿½è¸ª (OpenTelemetry)                                   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

<div align="center">

**[ğŸ  é¦–é¡µ](../README.md)** â€¢ **[ğŸ“– ç”¨æˆ·æŒ‡å—](USER_GUIDE.md)** â€¢ **[ğŸ“˜ API å‚è€ƒ](API_REFERENCE.md)**

</div>
