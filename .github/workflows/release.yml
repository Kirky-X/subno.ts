name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v0.2.0, v1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as prerelease'
        required: false
        type: boolean
        default: false
      create_tag:
        description: 'Create and push git tag'
        required: false
        type: boolean
        default: true

permissions:
  contents: write
  packages: write
  id-token: write

env:
  NODE_VERSION: '20'
  REGISTRY: ghcr.io
  RELEASE_VERSION: ${{ github.event.inputs.version || github.ref_name }}

jobs:
  setup:
    name: Setup Tag
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && inputs.create_tag == true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Validate version format
        id: validate
        run: |
          VERSION="${{ inputs.version }}"
          if [[ ! $VERSION =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Version must start with 'v' and be in semantic version format (e.g., v0.2.0)"
            exit 1
          fi
          echo "validated_version=$VERSION" >> $GITHUB_OUTPUT

      - name: Check if tag exists
        id: check-tag
        run: |
          TAG="${{ steps.validate.outputs.validated_version }}"
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "::warning::Tag $TAG already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create and push tag
        if: steps.check-tag.outputs.exists == 'false'
        run: |
          TAG="${{ steps.validate.outputs.validated_version }}"
          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"
          echo "âœ… Created and pushed tag: $TAG"

  validate:
    name: Validate
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ github.workspace }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run lint
        run: npm run lint

      - name: Run type check
        run: npx tsc --noEmit

      - name: Run tests
        run: npm test -- --run

  build:
    name: Build & Package
    runs-on: ubuntu-latest
    needs: validate
    defaults:
      run:
        working-directory: ${{ github.workspace }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build
        env:
          NEXT_TELEMETRY_DISABLED: 1

      - name: Create release package
        run: |
          mkdir -p release-package
          cp -r .next release-package/
          cp -r public release-package/
          cp package.json release-package/
          cp package-lock.json release-package/
          cp next.config.ts release-package/
          cp tsconfig.json release-package/
          cp -r src release-package/
          cp .env.example release-package/
          cp drizzle.config.ts release-package/
          echo "subno.ts" > release-package/NAME
          echo "${{ github.ref_name }}" > release-package/VERSION
          tar -czf subno-ts-release.tar.gz release-package/

      - name: Upload release artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-package
          path: subno-ts-release.tar.gz
          retention-days: 5

  publish-npm:
    name: Publish to NPM
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref_name, 'v')
    defaults:
      run:
        working-directory: ${{ github.workspace }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build
        env:
          NEXT_TELEMETRY_DISABLED: 1

      - name: Publish to NPM
        run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build
    defaults:
      run:
        working-directory: ${{ github.workspace }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version info
        id: version
        run: |
          VERSION="${{ env.RELEASE_VERSION }}"
          echo "version=${VERSION#v}" >> $GITHUB_OUTPUT
          echo "tag=$VERSION" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            const { data: commits } = await github.rest.repos.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 50
            });

            let changelog = '# Release Notes\n\n';
            changelog += `## ${process.env.TAG_VERSION}\n\n`;

            const features = [];
            const fixes = [];
            const docs = [];

            for (const commit of commits) {
              const msg = commit.commit.message;
              const type = msg.split(':')[0]?.toLowerCase() || '';

              if (type.includes('feat')) {
                features.push(`- ${msg.split(':').slice(1).join(':').trim()}`);
              } else if (type.includes('fix') || type.includes('security')) {
                fixes.push(`- ${msg.split(':').slice(1).join(':').trim()}`);
              } else if (type.includes('docs')) {
                docs.push(`- ${msg.split(':').slice(1).join(':').trim()}`);
              }
            }

            if (features.length > 0) {
              changelog += '### Features\n' + features.join('\n') + '\n\n';
            }
            if (fixes.length > 0) {
              changelog += '### Bug Fixes\n' + fixes.join('\n') + '\n\n';
            }
            if (docs.length > 0) {
              changelog += '### Documentation\n' + docs.join('\n') + '\n';
            }

            return changelog;
        env:
          TAG_VERSION: ${{ steps.version.outputs.version }}

      - name: Write release body
        run: |
          echo "${{ steps.changelog.outputs.result }}" > release-body.md

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: release-package
          path: .

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: subno-ts-release.tar.gz
          name: Release ${{ steps.version.outputs.version }}
          tag_name: ${{ steps.version.outputs.tag }}
          body_path: release-body.md
          draft: false
          prerelease: ${{ github.event.inputs.prerelease == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
